{% extends "base.html" %}

{% block title %}{{ product['canonical_name'] }} - Каталог смартфонов{% endblock %}

{% block content %}
<!-- Хлебные крошки -->
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/">Главная</a></li>
        <li class="breadcrumb-item"><a href="/search">Поиск</a></li>
        <li class="breadcrumb-item active">{{ product['canonical_name'] }}</li>
    </ol>
</nav>

<div class="row">
    <!-- Информация о товаре -->
    <div class="col-md-5">
        <div class="card mb-4">
            <div class="card-body">
                <h2 class="card-title">{{ product['canonical_name'] }}</h2>
                
                <div class="mb-3">
                    <span class="badge bg-primary fs-6">{{ product['brand'] }}</span>
                    <span class="badge bg-secondary fs-6">{{ product['model'] }}</span>
                </div>
                
                {% if price_stats %}
                <div class="price-summary p-3 bg-light rounded mb-3">
                    <h4>Сводка по ценам:</h4>
                    <div class="row text-center">
                        <div class="col">
                            <div class="text-success">
                                <h3>{{ "%.0f"|format(price_stats['min']) }} ₽</h3>
                                <small>Минимальная</small>
                            </div>
                        </div>
                        <div class="col">
                            <div class="text-primary">
                                <h3>{{ "%.0f"|format(price_stats['avg']) }} ₽</h3>
                                <small>Средняя</small>
                            </div>
                        </div>
                        <div class="col">
                            <div class="text-danger">
                                <h3>{{ "%.0f"|format(price_stats['max']) }} ₽</h3>
                                <small>Максимальная</small>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
                
                {% if attributes %}
                <h5 class="mt-4">Характеристики:</h5>
                <table class="table table-sm">
                    {% for attr in attributes %}
                    <tr>
                        <th>{{ attr['attribute_name'] }}</th>
                        <td>{{ attr['attribute_value'] }}</td>
                    </tr>
                    {% endfor %}
                </table>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Предложения от магазинов -->
    <div class="col-md-7">
        <div class="card">
            <div class="card-header bg-light">
                <h4 class="mb-0">
                    <i class="bi bi-shop"></i> Предложения от магазинов
                    <span class="badge bg-primary float-end">{{ offers|length }} предложений</span>
                </h4>
            </div>
            <div class="card-body">
                {% if offers %}
                <div class="list-group">
                    {% for offer in offers %}
                    <div class="list-group-item offer-row">
                        <div class="d-flex w-100 justify-content-between align-items-center">
                            <div>
                                <h5 class="mb-1">{{ offer['website_name'] }}</h5>
                                <p class="mb-1 text-muted">
                                    <small>{{ offer['original_name'] }}</small>
                                </p>
                                {% if offer['url'] %}
                                <small>
                                    <a href="{{ offer['url'] }}" target="_blank" class="text-decoration-none">
                                        <i class="bi bi-link"></i> Перейти в магазин
                                    </a>
                                </small>
                                {% endif %}
                            </div>
                            <div class="text-end">
                                <h4 class="text-primary mb-0 price">{{ offer['price'] }}</h4>
                                <small class="text-muted">
                                    <i class="bi bi-calendar"></i> 
                                    {{ offer['parsed_at'][:10] if offer['parsed_at'] else 'Н/Д' }}
                                </small>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                
                <!-- График цен -->
                {% if offers|length > 1 %}
                <div class="mt-4">
                    <h5>Сравнение цен:</h5>
                    <canvas id="priceChart" width="400" height="100"></canvas>
                    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
                    <script>
                        const ctx = document.getElementById('priceChart').getContext('2d');
                        const prices = [{% for offer in offers %}{{ offer['price'] }},{% endfor %}];
                        const websites = [{% for offer in offers %}'{{ offer['website_name'] }}',{% endfor %}];
                        
                        new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: websites,
                                datasets: [{
                                    label: 'Цена (руб.)',
                                    data: prices,
                                    backgroundColor: [
                                        'rgba(54, 162, 235, 0.5)',
                                        'rgba(255, 99, 132, 0.5)',
                                        'rgba(75, 192, 192, 0.5)',
                                        'rgba(255, 206, 86, 0.5)',
                                        'rgba(153, 102, 255, 0.5)'
                                    ],
                                    borderColor: [
                                        'rgba(54, 162, 235, 1)',
                                        'rgba(255, 99, 132, 1)',
                                        'rgba(75, 192, 192, 1)',
                                        'rgba(255, 206, 86, 1)',
                                        'rgba(153, 102, 255, 1)'
                                    ],
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                responsive: true,
                                plugins: {
                                    legend: {
                                        display: false
                                    }
                                },
                                scales: {
                                    y: {
                                        beginAtZero: false,
                                        title: {
                                            display: true,
                                            text: 'Цена (руб.)'
                                        }
                                    }
                                }
                            }
                        });
                    </script>
                </div>
                {% endif %}
                
                {% else %}
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i>
                    Нет доступных предложений для этого товара.
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Кнопки действий -->
        <div class="mt-3">
            <a href="/search?brand={{ product['brand'] }}" class="btn btn-outline-primary">
                <i class="bi bi-arrow-left"></i> Все товары {{ product['brand'] }}
            </a>
            <button onclick="window.history.back()" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-return-left"></i> Назад
            </button>
        </div>
    </div>
</div>
{% endblock %}